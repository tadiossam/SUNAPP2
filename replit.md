# Heavy Equipment Spare Parts Management System

## Overview
A comprehensive web application for industrial equipment maintenance, focusing on efficient management of heavy equipment inventory and spare parts. It features a detailed parts catalog with 3D models, streamlines searching and visualization, and integrates robust garage, equipment reception, and multi-level approval workflows to enhance maintenance operations and tracking. The project aims to significantly improve efficiency in heavy equipment maintenance.

## Recent Changes (November 2025)
- **Logo Upload and Display System**: Fixed logo customization feature to use local file storage at `public/uploads/` for uploaded company logos. Updated logo upload endpoint to save files to the correct directory. Implemented logo display on both Login page and AppSidebar - when a logo is uploaded via Admin Settings → Customisations tab, it automatically appears in place of default icons (Shield on login, Wrench on sidebar). Logo images are served via `/uploads/` static route and support standard image formats with 30MB size limit. Falls back to default icons when no logo is set.
- **Spare Parts Inventory Statistics Cards**: Added three real-time, interactive inventory statistic cards at the top of the Spare Parts Catalog page showing: Total Items (total count of all parts), Low On Stock (count of parts with low_stock status), and Out of Stock (count of parts with out_of_stock status). Statistics are calculated dynamically from the parts data and update automatically when inventory changes. Each card is clickable and navigates to a filtered view showing only items matching that status, with a "Back to Full Catalog" button for easy navigation. Hidden the "3D Model Available" section, "3D Dimension Viewer" section, and "Part Location" section in the part details dialog for a cleaner, more focused interface.
- **Per-Category Delete Buttons on Equipment Page**: Added individual delete functionality to each equipment category card on the Equipment Inventory page. Each category card now displays two action buttons: "Delete Category" (removes the category record only, visible when a matching category exists) and "Delete All Units" (removes all equipment units of that type). Both buttons trigger confirmation dialogs with clear warnings, are protected by CEO/Admin role checks, and send email notifications to CEO when performed by Admins. Backend includes new storage method `deleteEquipmentByType(equipmentType: string)` and route `POST /api/equipment/delete-by-type` for type-specific deletions. Frontend uses mutations with automatic cache invalidation and toast feedback showing deleted counts.
- **D365 BC Equipment Import with Description Parsing**: Moved D365 Fixed Asset import from Equipment page to Admin Settings → Dynamics 365 tab, matching the spare parts workflow for consistency. Implemented intelligent description parsing in `server/parse-equipment-description.ts` that extracts equipment name, plate number (P/N), and serial number (S/N) from D365 descriptions. The parser supports multiple plate number formats including alphanumeric patterns (AA-12345, SSC-001, CAT-1234) and numeric patterns (3-35809ET) using regex `/\b([A-Z0-9]+-[A-Z0-9]+)\b/i`. Replaced pattern-based categorization (0000/0001+) with description parsing for more accurate data extraction. Import endpoint `/api/dynamics365/import-equipment` now uses parsed data to populate equipment records with structured information.
- **Local Media Storage Setup**: Created organized folder structure for local media storage at `public/uploads/` with three dedicated folders: `employees/`, `spare-parts/`, and `equipment/`. All uploaded photos and videos are now stored locally instead of cloud storage. Includes .gitignore configuration to prevent committing uploaded media while preserving folder structure. Configuration file at `server/config/media-storage.ts` defines paths, allowed extensions (images: .jpg, .jpeg, .png, .gif, .webp | videos: .mp4, .webm, .mov, .avi), and file size limits (images: 30MB, videos: 1000MB/1GB). Tutorial videos for spare parts are uploaded via `/api/parts/:id/tutorial/upload-local` endpoint and displayed in an HTML5 video player with full playback controls.
- **Fixed Spare Parts DELETE Endpoint**: Resolved 500 Internal Server Error when deleting spare parts. Added missing `deletePart()` method to both IStorage interface and DbStorage implementation in `server/storage.ts`. The method properly deletes spare parts from the database and returns success status.
- **D365 BC Item Import to Spare Parts Catalog**: Implemented complete workflow to import Items from Dynamics 365 Business Central directly into the spare parts catalog. Users can fetch items via Admin Settings → Dynamics 365 tab, select desired items using checkboxes, and click "Insert Selected" to add them to the catalog. The system automatically maps D365 fields (No, Description, Unit_Cost, InventoryField) to spare parts schema, handles duplicate detection, and provides detailed import results. Only Items (not Fixed Assets) can be imported to maintain data integrity.
- **Spare Parts Full CRUD Operations**: Added comprehensive Create, Read, Update, Delete functionality for spare parts catalog. CEO and Admin users can now create new parts with all fields including Manufacturing Specifications, edit existing parts with pre-populated data, and delete parts with confirmation dialogs. All operations include proper validation (required part number/name, whitespace trimming), role-based access control (case-insensitive), toast notifications, and cache invalidation for real-time UI updates.
- **Syncto365 Integration Added to Admin Settings**: Integrated Syncto365-style data table functionality into Admin Settings → Dynamics 365 tab. Users can now fetch Items or Fixed Assets from D365 BC, view them in a paginated table (20 records/page), select records via checkboxes, and navigate between pages. Includes comprehensive console logging for local testing and debugging.
- **PERMANENT FIX: Automatic parts_receipts creation**: Fixed `processItemRequisitionLineDecisions` function to automatically create `parts_receipts` records when store manager approves requisitions. This ensures ALL future work orders will show parts used and total costs in Maintenance History without manual intervention.
- **Fixed Maintenance History employee data display**: Updated `getAllWorkOrders` to query `work_order_memberships` table instead of non-existent `assignedToIds` array field. Employees now properly display in the "Employees Who Worked on This Equipment" dialog.
- **Retroactive parts_receipts creation**: Identified and fixed missing `parts_receipts` records for completed work orders. Affected work orders: WO-2025-004, WO-2025-006 (CA 600D), WO-2025-009, WO-2025-010, WO-2025-013. The Maintenance History page now correctly displays parts used and total costs for all equipment.
- **Data integrity audit**: Ran comprehensive audit of all completed work orders to ensure fulfilled requisition lines have corresponding `parts_receipts` records. All historical data has been corrected.

## User Preferences
I prefer iterative development with clear communication at each stage. Please ask for confirmation before implementing significant architectural changes or adding new external dependencies. I also prefer detailed explanations for complex technical decisions. Ensure all solutions are mobile-compatible, especially for iOS Safari.

## System Architecture

### UI/UX Decisions
The system utilizes an Industrial Material Design 3 theme, offering light/dark modes, professional blue primary colors, and Inter/JetBrains Mono typography. Key features include sidebar navigation, responsive data-dense layouts, comprehensive accessibility, and an interactive 3D viewer capable of displaying technical engineering drawings with millimeter-accurate dimensions, ISO 2768 tolerance standards, SVG annotations, and CAD export badges.

### Technical Implementations
The frontend is built with React 18, TypeScript, Vite, Shadcn UI, Tailwind CSS, Wouter for routing, and TanStack Query. The backend uses Express.js and Node.js, with PostgreSQL (Neon) and Drizzle ORM. Three.js is used for 3D rendering.

**Authentication & Access Control**: Employs JWT-based authentication and comprehensive Role-Based Access Control (RBAC) via a single `employees` table. Passwords are secured with bcrypt. The system includes case-insensitive role checks, admin superuser access with full visibility across dashboards, and helper functions for centralized role checking. Endpoints are protected based on roles such as `store_manager`, `verifier`, `supervisor`, `foreman`, and `team_member`. The application is a PWA optimized for mobile. Object storage for media and 3D models is handled by Replit Object Storage (Google Cloud Storage) using presigned URLs. Database queries are optimized with batch fetching. Work Order numbers use `WO-YYYY-XXX` format, Requisition numbers `REQ-YYYY-XXX`, and Purchase Order numbers `PO-YYYY-XXX`.

### Feature Specifications
- **Dashboard**: Dynamic analytics with real-time filtering, KPI cards, and various charts for performance tracking and cost distribution.
- **Equipment Inventory**: CRUD operations for equipment categories and units, with real-time UI updates and detailed modals.
- **Spare Parts Catalog**: Advanced filtering and detailed part information with media and compatibility.
- **3D Models Library**: Interactive viewer with upload and 360-degree rotation.
- **Maintenance Information System**: Guides, tutorials, tools lists, and time estimates.
- **Garage & Workshop Management**: CRUD for hierarchical garage and workshop structures, including foreman and team assignments.
- **Employee Management**: Single-table authentication, RBAC, and bcrypt hashing.
- **Work Order Management**: Features a multi-level approval system and multi-workshop assignment. Includes a redesigned form, team workflow (Foreman assigns → Team requests parts → Verification), and an Item Requisition System with multi-level approval (Team Member → Foreman → Store Manager). Automated purchase request creation for out-of-stock items. Features a comprehensive approval chain (Team Member → Foreman → Verifier → Supervisor → Final Completion) and a detailed status flow. Participant tracking and status history are maintained. A **Work Timer Tracking System** automatically tracks work duration, pauses for waiting periods (awaiting parts/purchase), and resumes when work continues, providing accurate active work duration.
  - **Work Order Status Flow**: `pending_allocation` (default on creation) → `pending_foreman_assignment` → `pending_team_acceptance` → `in_progress` → `pending_verification` → `verified` → `completed`. Status may also transition to `awaiting_parts` or `waiting_purchase` when parts are needed. Foremen see work orders in `pending_allocation`, `pending_foreman_assignment`, and `pending_team_acceptance` status on their pending tab. After verification, only the work order creator can mark it as completed.
- **Role-Specific Dashboards**: Dedicated dashboards for Store Managers, Foremen, Verifiers, and Team Performance pages with leaderboards.
- **Equipment Reception/Check-in**: Driver drop-off workflow with auto-generated reception numbers.
- **Equipment Maintenances Workflow**: Admin review for driver check-ins.
- **Equipment Inspection**: View of receptions, auto-generated inspection numbers, and service-type checklists.
- **Approval System**: Multi-level workflow for job orders, completions, parts requests, and inspections.
- **Item Requisition Forms**: Matches official forms with line-item descriptions, quantities, and multi-level signatures. Features a **Per-Line Foreman Approval System** with organized sub-tabs (Pending Review, Approved, Rejected) and individual line-item controls. Also includes an **Individual Line-Item Approval System** for Store Managers with partial fulfillment, automatic stock deduction, and purchase order generation.
- **Employee Performance Tracking**: Gamification system with daily/monthly/yearly leaderboards, calculating performance scores based on completed work orders and average completion time, excluding paused time.
- **Maintenance History**: Comprehensive equipment maintenance tracking page with searchable equipment selection (Combobox), six statistics cards (total maintenance, most frequent work type, average frequency, total parts used, total cost, unique employees), clickable maintenance cards showing work order details, assigned employees, completion dates, and duration. Automatically populated from completed work orders with parts usage data via `/api/parts-receipts` endpoint.
- **Currency Conversion**: Dynamic USD/ETB conversion in the parts catalog.
- **Attendance Device Integration**: Integration with ZKTeco iFace990 Plus for employee management.

## External Dependencies
- **Replit Object Storage**: For 3D models, images, and videos.
- **Neon**: PostgreSQL database hosting.
- **Resend**: Email notification service.
- **ZKTeco Biometric Device**: iFace990 Plus attendance device, utilizing the `zkteco-js` library.